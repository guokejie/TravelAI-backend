# 登录注册技术方案

## 1. 技术选型

### 1.1 认证方式
- **JWT (JSON Web Token)**：无状态认证，适合前后端分离架构
- **登录方式**：手机号 + 密码

### 1.2 加密算法
- **密码加密**：BCrypt（Spring Security 默认）
- **Token 签名**：HMAC-SHA256

### 1.3 安全措施
- 密码加密存储（BCrypt）
- JWT Token 过期机制
- 防止 XSS 攻击
- 请求频率限制
- 手机号格式校验

---

## 2. 数据库设计

### 2.1 用户表 (user)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 用户ID（雪花算法） | PRIMARY KEY |
| username | VARCHAR(50) | 用户名 | UNIQUE, NOT NULL |
| phone | VARCHAR(20) | 手机号（用于登录） | UNIQUE, NOT NULL |
| password | VARCHAR(100) | 密码（BCrypt加密） | NOT NULL |
| email | VARCHAR(100) | 邮箱 | UNIQUE |
| nickname | VARCHAR(50) | 昵称 | |
| avatar | VARCHAR(255) | 头像URL | |
| status | TINYINT | 状态（0禁用 1正常） | DEFAULT 1 |
| deleted | TINYINT | 逻辑删除 | DEFAULT 0 |
| create_time | DATETIME | 创建时间 | |
| update_time | DATETIME | 更新时间 | |

---

## 3. API 接口设计

### 3.1 注册接口

**请求**
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "phone": "13800138000",
  "password": "123456",
  "nickname": "测试用户"
}
```

**响应**
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "userId": 123456789,
    "username": "testuser",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### 3.2 登录接口

**请求**
```http
POST /api/auth/login
Content-Type: application/json

{
  "phone": "13800138000",
  "password": "123456"
}
```

**响应**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": 123456789,
    "username": "testuser",
    "phone": "13800138000",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expireTime": "2024-01-01T12:00:00"
  }
}
```

### 3.3 获取用户信息

**请求**
```http
GET /api/user/info
Authorization: Bearer {token}
```

**响应**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "userId": 123456789,
    "username": "testuser",
    "phone": "13800138000",
    "email": "test@example.com",
    "nickname": "测试用户",
    "avatar": "https://example.com/avatar.jpg"
  }
}
```

### 3.4 退出登录

**请求**
```http
POST /api/auth/logout
Authorization: Bearer {token}
```

**响应**
```json
{
  "code": 200,
  "message": "退出成功"
}
```

---

## 4. 项目结构

```
org.tech
├── common
│   ├── result           # 统一返回结果
│   ├── exception        # 全局异常处理
│   └── constants        # 常量定义
├── config               # 配置类
│   └── SecurityConfig   # 安全配置
├── controller           # 控制器
│   ├── AuthController   # 认证接口
│   └── UserController   # 用户接口
├── service              # 服务层
│   ├── AuthService      # 认证服务
│   └── UserService      # 用户服务
├── mapper               # 数据访问层
│   └── UserMapper       # 用户Mapper
├── entity               # 实体类
│   └── User             # 用户实体
├── dto                  # 数据传输对象
│   ├── LoginRequest     # 登录请求
│   └── RegisterRequest  # 注册请求
├── vo                   # 视图对象
│   ├── UserVO           # 用户信息
│   └── LoginVO          # 登录响应
└── util                 # 工具类
    ├── JwtUtil          # JWT工具
    └── PasswordUtil     # 密码工具
```

---

## 5. 核心代码实现要点

### 5.1 JWT 工具类

```java
public class JwtUtil {
    // 生成 Token
    public static String generateToken(Long userId, String username);

    // 解析 Token
    public static Claims parseToken(String token);

    // 验证 Token
    public static boolean validateToken(String token);

    // 获取用户ID
    public static Long getUserId(String token);
}
```

### 5.2 认证拦截器

```java
public class AuthInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request,
                            HttpServletResponse response,
                            Object handler) {
        // 1. 从请求头获取 Token
        // 2. 验证 Token 有效性
        // 3. 将用户信息存入 ThreadLocal
        return true;
    }
}
```

### 5.3 密码加密

```java
// 使用 BCrypt 加密密码
String hashedPassword = BCrypt.hashpw(rawPassword, BCrypt.gensalt());

// 验证密码
boolean matches = BCrypt.checkpw(rawPassword, hashedPassword);
```

---

## 6. 安全注意事项

### 6.1 密码安全
- 使用 BCrypt 加密，加盐存储
- 密码复杂度校验（6-20位，包含字母和数字）
- 防止暴力破解（登录失败次数限制）

### 6.2 Token 安全
- Token 存储在 localStorage
- 设置合理的过期时间（Access Token: 7天）
- 使用 HTTPS 传输

### 6.3 接口安全
- 实现请求频率限制
- 手机号格式校验（11位数字）
- 记录操作日志

---

## 7. 依赖配置

```xml
<!-- Spring Security -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>

<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.12.6</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.12.6</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.12.6</version>
    <scope>runtime</scope>
</dependency>
```

---

## 8. 实施步骤

1. 添加 Spring Security 和 JWT 依赖 ✓
2. 创建数据库表结构
3. 创建实体类和 DTO/VO
4. 实现 Mapper 和 Service
5. 实现 JWT 工具类
6. 实现登录注册接口
7. 配置 Security 过滤器链
8. 添加全局异常处理
9. 编写单元测试
10. 接口联调测试
